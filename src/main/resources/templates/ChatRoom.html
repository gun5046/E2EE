<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
        <script
            src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1 th:text="${receiver}"></h1>

<p>createKey</p>
<input type="file" id="create_key"/>
<p>GetPublicKey</p>
<input type="file" id="public_key"/>
<p>GetPrivateKey</p>
<input type="file" id="private_key"/>


<br/><br/>
<div class="container">
    <div class="header">
        <p id="room_name" th:text="${room_name}" type="text"></p>
    </div>

    <div class="content"  border = "red">
        <table id="msg_box" width="500px" border="red">

        </table>
    </div>

    <div class="send">
        <input id="sendMsg" placeholder="내용을 입력하세요" type="text">
        <button id="sendBtn">전송</button>
        <!--보낼 내용 & send btn-->
    </div>
</div>
</div>

<script th:inline="javascript">
    //javascript에서 thymeleaf 변수 사용할떄 -> /*[[${room_name}]]*/
	/*<![ CDATA[ */
    let sender=[[${sender}]];
    let receiver=[[${receiver}]];
    /* ]]> */

    let chatMessage = {
    sender : "",
    message : "",
    type : "",
    receiver :""
};
    
    function createKey(e){
    	var file = e.target.files[0];
    	if(!file){
    		return;
    	}
    	var reader = new FileReader();
    	reader.onload = function(e){
    		var contents = e.target.result;
    		console.log(contents);
    	}
    }
    
    document.getElementById('create_key').addEventListener('change', createKey, false);
    
    
    
    
    
let c_data;

let sendMsg= document.getElementById('sendMsg');
let sendBtn = document.getElementById("sendBtn");


window.onload = function() {

    let socket = new SockJS("/ws/chat");
    let stompClient = Stomp.over(socket);
	

	
    stompClient.connect({}, onConnected, connectError);

    sendMsg.addEventListener('keydown',function(event){
        if(event.keyCode==13){
            sendMessage(sendMsg.value);
        }
    })
    //onKeyDown(keycode값),  onKeyPress(ASCII값) :  키를누르면 이벤트발생후 문자 입력, onKeyUp : 키를 누르면 문자입력후 이벤트발생
    //keydown : 누르는 순간 발생 keyup : 눌렀다 떼는 순간 발생
    sendBtn.addEventListener('click',function(event){
        console.log(sendMsg.value);
        sendMessage(sendMsg.value);
    })

    function onConnected() {
        stompClient.subscribe('/topic/'+receiver, responseMessage); // subscribe 파라미터 : 1. 구독할 토픽 url 2. 콜백메소드
        stompClient.subscribe('topic/'+sender, responseMy);
        chatMessage.sender = sender;
        chatMessage.message = " 님이 입장하였습니다.";
        chatMessage.type = "Enter";
        chatMessage.receiver = receiver;
        let cmsg= JSON.stringify(chatMessage);


        stompClient.send("/app/chat.send",{"Type" : "Enter"},cmsg);// send 파라미터 : 1. 매핑url, 2. header정보(content-type 등) 3. 보낼 message
        console.log("보냄");
    }

    function sendMessage(msg){
        chatMessage.sender =sender;
        chatMessage.message = msg;
        chatMessage.type = "Chat";
        chatMessage.receiver = receiver;
        let cmsg= JSON.stringify(chatMessage);

        stompClient.send("/app/chat.send", {"Type" : "Send"}, cmsg);
        console.log("보냄");

    }
	

    function connectError() {
        alert("오류");
    }
    function disConnected() {
        console.log("연결이 종료되었습니다.");
    }
    function responseMessage(response) {

        let addSender=document.createElement("td");
        let addMsg =document.createElement("td");
        let parentTbody = document.getElementById("msg_box");
        let addBox=document.createElement("tr");
        let data=JSON.parse(response.body);
        if(data.type=="Enter"){
            //스타일 변경 중앙정렬
        }
        if(data.sender==sender){
            console.log("me");
            //스타일 변경
        }
        addSender.innerHTML = data.sender;
        addMsg.innerHTML = data.message;
        addMsg.style.color="red";
        parentTbody.appendChild(addBox);
        parentTbody.appendChild(addSender);
        parentTbody.appendChild(addMsg);

        console.log("수신");
    }
    
    function responseMy(response) {

        let addSender=document.createElement("td");
        let addMsg =document.createElement("td");
        let parentTbody = document.getElementById("msg_box");
        let addBox=document.createElement("tr");
        let data=JSON.parse(response.body);
        if(data.type=="Enter"){
            //스타일 변경 중앙정렬
        }
        if(data.sender==sender){
            console.log("me");
            //스타일 변경
        }
        addSender.innerHTML = data.sender;
        addMsg.innerHTML = data.message;
        addMsg.style.color="blue";
        parentTbody.appendChild(addBox);
        parentTbody.appendChild(addSender);
        parentTbody.appendChild(addMsg);

        console.log("수신");
    }
}

</script>
</body>
</html>